From 62f01721901accdc533b23c7790a252971a6b7fb Mon Sep 17 00:00:00 2001
From: X512 <danger_mail@list.ru>
Date: Mon, 26 Jul 2021 03:30:11 +0900
Subject: bus_managers/fdt: rewrite to support device manager node tree (2)

Change-Id: Ie7e81091c8829188aedd9548e7cd844dff610aef
---
 .../kernel/bus_managers/fdt/fdt_module.cpp    | 29 +++++++++++++++++--
 1 file changed, 27 insertions(+), 2 deletions(-)

diff --git a/src/add-ons/kernel/bus_managers/fdt/fdt_module.cpp b/src/add-ons/kernel/bus_managers/fdt/fdt_module.cpp
index 7e7f62e3bf..fa932d5071 100644
--- a/src/add-ons/kernel/bus_managers/fdt/fdt_module.cpp
+++ b/src/add-ons/kernel/bus_managers/fdt/fdt_module.cpp
@@ -359,8 +359,33 @@ fdt_device_get_interrupt(fdt_device* dev, uint32 ord,
 	int propLen;
 	const void* prop = fdt_getprop(gFDT, (int)fdtNode, "interrupts-extended",
 		&propLen);
-	if (prop == NULL)
-		return false;
+	if (prop == NULL) {
+		prop = fdt_getprop(gFDT, (int)fdtNode, "interrupts",
+			&propLen);
+		if (prop == NULL)
+			return false;
+
+		if ((ord + 1)*4 > (uint32)propLen)
+			return false;
+
+		if (interrupt != NULL)
+			*interrupt = fdt32_to_cpu(*(((uint32*)prop) + ord));
+
+		if (interruptController != NULL) {
+			prop = fdt_getprop(gFDT, (int)fdtNode, "interrupt-parent",
+				&propLen);
+			if (prop != NULL && propLen == 4) {
+				uint32 phandle = fdt32_to_cpu(*(uint32*)prop);
+
+				fdt_bus* bus;
+				ASSERT(gDeviceManager->get_driver(
+					dev->bus, NULL, (void**)&bus) >= B_OK);
+
+				*interruptController = fdt_bus_node_by_phandle(bus, phandle);
+			}
+		}
+		return true;
+	}
 
 	// TODO: use '#interrupt-cells' to identify field sizes
 
-- 
2.30.2

